---
title: FDA Table 04
subtitle: Subject Populations, Randomized Population, Pooled Analysis (or Trial X) 
categories: [table, FDA, safety, disposition]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(gtsummary)
library(formatters)

adsl <- random.cdisc.data::cadsl

# Pre-processing --------------------------------------------
data <- adsl |>
  mutate(
    across(all_of(c("ITTFL", "SAFFL")), ~ with_label(. == "Y", lbl_pop_vars[match(cur_column(), pop_vars)])),
    rand_fl = !is.na(RANDDT),
    prot_fl = is.na(DCSREAS)
  )

pop_vars <- c("rand_fl", "ITTFL", "SAFFL", "prot_fl")
lbl_pop_vars <- c("Subjects randomized" ,"ITT population", "Safety population", "Per-protocol population")
```

## Build Table

```{r tbl, results='hide'}
tbl <- data |>
  gtsummary::tbl_summary(
    by = "ARM",
    statistic = list(all_dichotomous() ~ "{n} ({p}%)"),
    include = all_of(pop_vars),
    digits = list(gtsummary::all_categorical() ~ c(0, 1)),
    label = as.list(lbl_pop_vars) |> setNames(pop_vars)
  ) |>
  # Define which variables are children of parent variables
  modify_indent(
    columns = "label",
    rows = variable != "rand_fl",
    indent = 4L
  ) |>
  modify_header(label = "**Population**")

tbl
```

```{r eval=FALSE, include=FALSE}
# Run chunk locally to generate image file
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- gather_ard(tbl)
ard
```

```{r, echo=FALSE}
# Print full ARD
withr::local_options(width = 9999)
print(ard, columns = "all")
```
:::
