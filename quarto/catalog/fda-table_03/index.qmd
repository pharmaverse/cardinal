---
title: FDA Table 03
subtitle: Subject Screening and Enrollment, Screening Population, Trials A and B
categories: [table, FDA, safety, disposition]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(formatters)
library(cards)
library(gtsummary)

adsl <- random.cdisc.data::cadsl

set.seed(1)
adsl$RANDDT[sample(seq_len(nrow(adsl)), 100)] <- NA
scrnfail_reas_lvls <- c(
  "Inclusion/exclusion criteria not met", "Subject noncompliance", "Consent withdrawn", "Other"
)
data <- adsl |>
  mutate(
    ENRLDT = RANDDT,
    SCRNFL = with_label(TRUE, "Subjects screened"),
    SCRNFRS = factor(sample(scrnfail_reas_lvls, size = nrow(adsl), replace = TRUE),
      levels = scrnfail_reas_lvls
    ),
    ENRLFL = with_label(!is.na(ENRLDT), "Subjects enrolled"),
    RANDFL = with_label(!is.na(RANDDT), "Subjects randomized")
  )
data$SCRNFRS[data$SCRNFL == "N" | !is.na(data$ENRLDT)] <- NA
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- data |>
  ard_stack(
    ard_dichotomous(
      variables = SCRNFL,
      value = list(SCRNFL = TRUE),
      statistic = everything() ~ c("n")
    ),
    ard_categorical(
      variables = SCRNFRS,
      statistic = everything() ~ c("n", "p"),
      denominator = data
    ),
    ard_dichotomous(
      variables = c(ENRLFL, RANDFL),
      value = list(ENRLFL = TRUE, RANDFL = TRUE),
      statistic = everything() ~ c("n", "p"),
      denominator = data
    )
  )

ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard, columns = "all", n = 40)
```

## Build Table

```{r tbl, message=FALSE, warning=FALSE, results='hide'}
tbl <- data |> 
  # create a flag for screen failure
  mutate(screen_fail = !ENRLFL) |> 
  tbl_summary(
    include = c(SCRNFL, screen_fail, SCRNFRS, ENRLFL, RANDFL),
    # only show count for number of screened subjects
    statistic = SCRNFL ~ "{n}",
    # suppress number of missing observations
    missing = "no",
    # specify the denominator is always the no. obs. in `data`
    percent = data,
    # present SCRNFRS in descending order of frequency 
    sort = SCRNFRS ~ "frequency",
    # udpate default screen failure label
    label = list(screen_fail = "Screening failures")
  ) |> 
  # remove the blank header row for SCRNFRS
  remove_row_type(SCRNFRS, type = "header") |> 
  remove_footnote_header() |> 
  modify_header(
    label = "**Disposition**",
    stat_0 = "**Trial A**"
  )

tbl
```

```{r eval=FALSE, include=FALSE}
# Run chunk locally to generate image file
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
```
:::
