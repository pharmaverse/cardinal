---
title: FDA Table 03
subtitle: Subject Screening and Enrollment, Screening Population, Trials A and B
categories: [table, FDA, safety, disposition]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(cards)
library(gtsummary)

adsl <- pharmaverseadam::adsl

set.seed(1)
adsl$RANDDT[sample(seq_len(nrow(adsl)), 100)] <- NA
scrnfail_reas_lvls <- c(
  "Inclusion/exclusion criteria not met", "Subject noncompliance", "Consent withdrawn", "Other"
)
data <- adsl |>
  mutate(
    ENRLDT = RANDDT,
    SCRNFL = TRUE,
    SCRNFRS = factor(sample(scrnfail_reas_lvls, size = nrow(adsl), replace = TRUE),
      levels = scrnfail_reas_lvls
    ),
    ENRLFL = !is.na(ENRLDT),
    RANDFL = !is.na(RANDDT)
  )
data$SCRNFRS[data$SCRNFL == "N" | !is.na(data$ENRLDT)] <- NA
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- data |>
  ard_stack(
    ard_tabulate_value(
      variables = SCRNFL,
      value = list(SCRNFL = TRUE),
      statistic = everything() ~ c("n")
    ),
    ard_tabulate(
      variables = SCRNFRS,
      statistic = everything() ~ c("n", "p"),
      denominator = data
    ),
    ard_tabulate_value(
      variables = c(ENRLFL, RANDFL),
      value = list(ENRLFL = TRUE, RANDFL = TRUE),
      statistic = everything() ~ c("n", "p"),
      denominator = data
    )
  )

ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard, columns = "all", n = 40)
```

## Build Table

```{r tbl, message=FALSE, warning=FALSE, results='hide'}
tbl_scrn <- tbl_summary(
  data = data,
  by = TRT01A,
  include = "SCRNFL",
  missing = "no",
  label = ~"Subjects screened"
)

tbl_scrnfrs <- tbl_hierarchical(
  data = data,
  denominator = adsl,
  id = USUBJID,
  by = TRT01A,
  variables = "SCRNFRS",
  label = list(..ard_hierarchical_overall.. = "Screening failures"),
  overall_row = TRUE
) |>
  modify_indent(columns = label, rows = row_type == "level", indent = 4L) |>
  modify_indent(columns = label, rows = variable == "SCRNFRS", indent = 8L)

tbl_enrl_rand <- tbl_summary(
  data = data,
  by = TRT01A,
  include = c("ENRLFL", "RANDFL"),
  missing = "no",
  label = list(ENRLFL = "Subjects enrolled", RANDFL = "Subjects randomized")
)

tbl <- list(tbl_scrn, tbl_scrnfrs, tbl_enrl_rand) |>
  tbl_stack() |>
  modify_header(label = "**Disposition**")

tbl
```

```{r eval=FALSE, include=FALSE}
# Run chunk locally to generate image file
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- gather_ard(tbl)

ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard)
```
:::
