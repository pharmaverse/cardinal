---
title: FDA Table 3
subtitle: Patient Screening and Enrollment, Trials A and B
categories: [table, FDA, safety, disposition]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(gtsummary)

adsl <- random.cdisc.data::cadsl

set.seed(1)
adsl$RANDDT[sample(seq_len(nrow(adsl)), 100)] <- NA
scrnfail_reas_lvls <- c(
  "Inclusion/exclusion criteria not met", "Patient noncompliance", "Consent withdrawn", "Other"
)
adsl <- adsl %>%
  mutate(
    ENRLDT = RANDDT,
    SCRNFL = "Y",
    SCRNFRS = factor(sample(scrnfail_reas_lvls, size = nrow(adsl), replace = TRUE),
      levels = scrnfail_reas_lvls
    ),
    SCRNFAILFL = ifelse(is.na(ENRLDT), "Y", "N")
  )
adsl$SCRNFRS[adsl$SCRNFL == "N" | !is.na(adsl$ENRLDT)] <- NA
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
make_table_03 <- function(df,
                          denominator = NULL,
                          return_ard = TRUE,
                          arm_var = "ARM",
                          id_var = "USUBJID",
                          scrnfl_var = "SCRNFL",
                          scrnfailfl_var = "SCRNFAILFL",
                          scrnfail_var = "SCRNFRS") {
  ard <- ard_table_03(
    df = df,
    denominator = denominator,
    arm_var = arm_var,
    id_var = id_var,
    scrnfl_var = scrnfl_var,
    scrnfailfl_var = scrnfailfl_var,
    scrnfail_var = scrnfail_var
  )

  tbl <- make_table_03_gtsummary(
    df = df,
    denominator = denominator,
    arm_var = arm_var,
    id_var = id_var,
    scrnfl_var = scrnfl_var,
    scrnfailfl_var = scrnfailfl_var,
    scrnfail_var = scrnfail_var
  )

  if (return_ard) {
    return(list(table = tbl, ard = ard))
  } else {
    return(tbl)
  }
}

preproc_df_table_03 <- function(df,
                                arm_var = "ARM",
                                id_var = "USUBJID",
                                scrnfl_var = "SCRNFL",
                                scrnfailfl_var = "SCRNFAILFL",
                                scrnfail_var = "SCRNFRS") {
  df %>%
    df_explicit_na() %>%
    mutate(
      SCRNFL = with_label(.data[[scrnfl_var]] == "Y", "Patients screened"),
      SCRNFL = with_label(!is.na(scrnfail_var), "Screnning failures"),
      ENRLFL = with_label(!is.na(ENRLDT), "Patients enrolled"),
      RANDFL = with_label(!is.na(RANDDT), "Patients randomized")
    )
}

ard_table_03 <- function(df,
                         denominator = NULL,
                         arm_var = "ARM",
                         id_var = "USUBJID",
                         scrnfl_var = "SCRNFL",
                         scrnfailfl_var = "SCRNFAILFL",
                         scrnfail_var = "SCRNFRS") {
  df <- preproc_df_table_03(df, arm_var, id_var, scrnfl_var, scrnfailfl_var, scrnfail_var)

  if (is.null(denominator)) {
    denominator <- df
  } else {
    denominator <- alt_counts_df_preproc(denominator, id_var, arm_var)
  }

  scrn_ard <- df |>
    group_by(!!rlang::sym(arm_var)) |>
    ard_dichotomous(
      variables = SCRNFL,
      value = list(SCRNFL = TRUE),
      statistic = everything() ~ c("n"),
      denominator = denominator
    )

  scrnfail_ard <- df |>
    group_by(!!rlang::sym(arm_var)) |>
    ard_categorical(
      variables = SCRNFRS,
      statistic = everything() ~ c("n", "p")
    )

  enrl_rand_ard <- df |>
    group_by(!!rlang::sym(arm_var)) |>
    ard_dichotomous(
      variables = c(ENRLFL, RANDFL),
      value = list(ENRLFL = TRUE, RANDFL = TRUE),
      statistic = everything() ~ c("n", "p"),
      denominator = denominator
    )

  ard <- bind_ard(scrn_ard, scrnfail_ard, enrl_rand_ard)

  ard
}

make_table_03_gtsummary <- function(df,
                                    denominator = NULL,
                                    arm_var = "ARM",
                                    id_var = "USUBJID",
                                    scrnfl_var = "SCRNFL",
                                    scrnfailfl_var = "SCRNFAILFL",
                                    scrnfail_var = "SCRNFRS") {
  df <- preproc_df_table_03(df, arm_var, id_var, scrnfl_var, scrnfailfl_var, scrnfail_var)

  if (is.null(denominator)) {
    denominator <- df
  } else {
    denominator <- alt_counts_df_preproc(denominator, id_var, arm_var)
  }

  tbl <- df %>%
    select("ARM", scrnfl_var, scrnfail_var, "ENRLFL", "RANDFL") %>%
    tbl_summary(
      by = arm_var,
      label = list(
        scrnfl_var ~ "Patients screened",
        scrnfail_var ~ "Screening failures"
      ),
      missing = "no"
    ) %>%
    modify_header(label ~ "**Disposition**")

  tbl
}

ard <- make_table_03(df = adsl, return_ard = TRUE)$ard

ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard, columns = "all", n = 40)
```

## Build Table

```{r tbl, message=FALSE, warning=FALSE, results = 'hide'}
tbl <- make_table_03(df = adsl)$table

tbl
```

```{r eval=FALSE, include=FALSE}
# Run chunk locally to generate image file
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='60%'}
```
:::
