---
title: Subjects With Adverse Events by Organ System and OCMQ, Safety Population, Pooled Analysis (or Trial X) 
subtitle: FDA Table 17
categories: [table, FDA, safety, adverse events]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='45%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(cards)
library(gtsummary)

adae <- pharmaverseadam::adae |>
  rename(OCMQ01SC = AEHLTCD, OCMQ01NAM = AEHLT)

adsl <- pharmaverseadam::adsl

set.seed(23)
adae$OCMQ01SC <- sample(c("BROAD", "NARROW"), size = nrow(adae), replace = TRUE)

# Pre-processing --------------------------------------------
adae <- adae |>
  # safety population
  filter(SAFFL == "Y") |>
  # filter 0CMQ to truncate table
  filter(OCMQ01NAM %in% c("HLT_0649", "HLT_0644", " HLT_0570", " HLT_0256", "HLT_0742", "HLT_0244", "HLT_0097", "HLT_0738"))

adsl <- adsl |>
  # safety population
  filter(SAFFL == "Y")
```

## Build Table

```{r tbl, results = 'hide'}
tbl <- adae |>
  select(OCMQ01SC, TRT01A, OCMQ01NAM, AEBODSYS, USUBJID) |>
  # setting an explicit level for NA values so empty strata combinations are shown.
  mutate(across(everything(), ~ {
    if (anyNA(.)) {
      forcats::fct_na_value_to_level(as.factor(.), level = "<Missing>")
    } else {
      .
    }
  })) |>
  tbl_strata(
    strata = OCMQ01SC,
    ~ tbl_hierarchical(
      .x,
      by = TRT01A,
      variables = c(AEBODSYS, OCMQ01NAM),
      id = USUBJID,
      denominator = adsl,
      # variables to calculate rates for
      include = c(OCMQ01NAM),
      label = list(OCMQ01NAM ~ "OCMQ", AEBODSYS ~ "System Organ Class")
    )
  ) |>
  modify_missing_symbol("NA", columns = everything(), rows = row_type == "level")

tbl
```

```{r eval=FALSE, include=FALSE}
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='45%'}
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- gather_ard(tbl)
ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard, columns = "all")
```
:::
