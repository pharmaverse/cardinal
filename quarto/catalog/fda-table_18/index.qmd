---
title: FDA Table 18
subtitle: Summary Assessment of [Insert AE of Interest], Safety Population, Pooled Analysis (or Trial X)
categories: [table, FDA, safety, adverse events]
---

::: panel-tabset
## Table Preview

```{r img, echo=FALSE, fig.align='center', out.width='45%'}
knitr::include_graphics("result.png")
```

## Setup

```{r setup, message=FALSE}
# Load libraries & data -------------------------------------
library(dplyr)
library(cards)
library(cardx)
library(gtsummary)

adsl <- random.cdisc.data::cadsl
adae <- random.cdisc.data::cadae

set.seed(1)
adae$AESIFL <- ifelse(adae$AESOC %in% c("cl A", "cl D"), "Y", "N")

# Pre-processing --------------------------------------------
adsl <- adsl |>
  filter(SAFFL == "Y") # safety population

data <- adae |>
  filter(
    SAFFL == "Y", # safety population
    AESIFL == "Y" # AESI assessment
  )

# dataset of AE flag variable counts by subject
data_ae_fl <-
  adsl |>
  select(USUBJID, TRT01A) |>
  # create subject-level flags from adae data
  left_join(
    data |>
      select(USUBJID, AESER, AESDTH, AESLIFE, AESHOSP, AESDISAB, AESCONG, AESMIE, AEACN) |>
      mutate(
        # Serious AE
        ae_ser = any(AESER == "Y"),
        # Serious AE leading to death
        ae_ser_death = any(AESER == "Y" & AESDTH == "Y"),
        ae_ser_life = any(AESER == "Y" & AESLIFE == "Y"),
        ae_ser_hosp = any(AESER == "Y" & AESHOSP == "Y"),
        ae_ser_disab = any(AESER == "Y" & AESDISAB == "Y"),
        ae_ser_cong = any(AESER == "Y" & AESCONG == "Y"),
        ae_ser_oth = any(AESER == "Y" & AESMIE == "Y"),
        # AE resulting in discontinuation
        ae_withdraw = any(AEACN == "DRUG WITHDRAWN"),
        .by = USUBJID
      ),
    by = "USUBJID"
  ) |>
  distinct(USUBJID, .keep_all = TRUE) |>
  # add number of AEs
  left_join(
    data |> summarise(.by = USUBJID, ae_count = n()),
    by = "USUBJID",
    relationship = "one-to-one"
  )
```

## Build Table

```{r tbl, results = 'hide'}
## AE grouping flags section --------
tbl_ae_gp <- data |>
  tbl_hierarchical(
    variables = AEDECOD,
    id = USUBJID,
    denominator = adsl,
    by = TRT01A,
    overall_row = TRUE,
    label = list(
      ..ard_hierarchical_overall.. = "[Insert AE of Interest]",
      AEDECOD = "AE of Interest Assessment"
    )
  ) |>
  modify_indent(columns = label, rows = variable != "..ard_hierarchical_overall..", indent = 4L)

## Maximum severity section ---------
tbl_ae_sev <- data |>
  ard_tabulate_max(variables = AESEV, id = USUBJID, by = TRT01A, denominator = adsl, quiet = TRUE) |>
  tbl_ard_summary(by = TRT01A, label = list(AESEV = "Maximum severity"))

## Events section -------------------
tbl_ae_fl <- data_ae_fl |>
  tbl_summary(
    by = "TRT01A",
    include = c(ae_ser, ae_ser_death, ae_ser_life, ae_ser_hosp, ae_ser_disab, ae_ser_cong, ae_ser_oth, ae_withdraw),
    missing = "no",
    percent = adsl,
    label = list(
      ae_ser = "SAE",
      ae_ser_death = "Death",
      ae_ser_life = "Life-threatening",
      ae_ser_hosp = "Initial or prolonged hospitalization",
      ae_ser_disab = "Disability or permanent damage",
      ae_ser_cong = "Congenital anomaly or birth defect",
      ae_ser_oth = "Other",
      ae_withdraw = "Resulting in treatment discontinuation"
    )
  ) |>
  modify_indent(columns = label, rows = !variable %in% c("ae_ser", "ae_withdraw"), indent = 4L)

## Build table ----------------------
tbl <- tbl_stack(list(tbl_ae_gp, tbl_ae_sev, tbl_ae_fl), quiet = TRUE)

tbl
```

```{r eval=FALSE, include=FALSE}
gt::gtsave(as_gt(tbl), filename = "result.png")
```

```{r img, echo=FALSE, fig.align='center', out.width='45%'}
```

## Build ARD

```{r ard, message=FALSE, warning=FALSE, results='hide'}
ard <- gather_ard(tbl)
ard
```

```{r, echo=FALSE}
# Print ARD
withr::local_options(width = 9999)
print(ard)
```
:::
